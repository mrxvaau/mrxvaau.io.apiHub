name: Simple Deploy

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with secrets
        run: |
          # Inject environment variables
          sed -i "s|{{SUPABASE_URL}}|${{ secrets.SUPABASE_URL }}|g" index.html
          sed -i "s|{{SUPABASE_ANON_KEY}}|${{ secrets.SUPABASE_ANON_KEY }}|g" index.html  
          sed -i "s|{{WHATSAPP_NUMBER}}|${{ secrets.WHATSAPP_NUMBER }}|g" index.html
          
          echo "âœ… Variables injected successfully"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:name: Deploy API Hub with Secrets

# Triggers
on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

# Required permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build Job
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Verify Secrets Exist
      run: |
        echo "Checking if required secrets are available..."
        if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
          echo "âŒ SUPABASE_URL secret is missing!"
          echo "Go to Settings â†’ Secrets and variables â†’ Actions"
          echo "Add SUPABASE_URL with your Supabase project URL"
          exit 1
        fi
        
        if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
          echo "âŒ SUPABASE_ANON_KEY secret is missing!"
          echo "Go to Settings â†’ Secrets and variables â†’ Actions"  
          echo "Add SUPABASE_ANON_KEY with your Supabase anon key"
          exit 1
        fi
        
        if [ -z "${{ secrets.WHATSAPP_NUMBER }}" ]; then
          echo "âŒ WHATSAPP_NUMBER secret is missing!"
          echo "Go to Settings â†’ Secrets and variables â†’ Actions"
          echo "Add WHATSAPP_NUMBER with your WhatsApp number"
          exit 1
        fi
        
        echo "âœ… All required secrets are present"
        
    - name: ğŸ—ï¸ Build with Environment Variables
      run: |
        echo "ğŸš€ Starting build process..."
        
        # Create build directory
        mkdir -p dist
        
        # Inject secrets into HTML template
        sed "s|{{SUPABASE_URL}}|${{ secrets.SUPABASE_URL }}|g; s|{{SUPABASE_ANON_KEY}}|${{ secrets.SUPABASE_ANON_KEY }}|g; s|{{WHATSAPP_NUMBER}}|${{ secrets.WHATSAPP_NUMBER }}|g" index.html > dist/index.html
        
        # Copy additional files if they exist
        [ -f favicon.ico ] && cp favicon.ico dist/ || echo "No favicon found"
        [ -d assets ] && cp -r assets dist/ || echo "No assets folder found"
        [ -f robots.txt ] && cp robots.txt dist/ || echo "No robots.txt found"
        
        echo "ğŸ“ Build directory contents:"
        ls -la dist/
        
        # Verify injection worked (without exposing secrets)
        if grep -q "{{" dist/index.html; then
          echo "âŒ Template variables were not replaced properly!"
          echo "The following placeholders were found:"
          grep -o "{{[^}]*}}" dist/index.html || true
          exit 1
        fi
        
        echo "âœ… All template variables successfully replaced"
        echo "âœ… Build completed successfully!"
        
    - name: ğŸ“„ Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¦ Upload Build Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  # Deploy Job
  deploy:
    # Run only after build succeeds
    needs: build
    
    # Deploy to GitHub Pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Your site is now live at: ${{ steps.deployment.outputs.page_url }}"
        echo "âœ… Credentials injected securely via GitHub Secrets"
        echo ""
        echo "Next steps:"
        echo "1. Visit your site and test user registration"
        echo "2. Setup your Supabase database using the provided SQL"
        echo "3. Make yourself admin in Supabase"
        echo "4. Start selling API keys! ğŸ’°"

  # Optional: Notification job (runs even if deployment fails)
  notify:
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Deployment Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment Status: SUCCESS"
          echo "ğŸ¯ Site is live and ready for users!"
        else
          echo "âŒ Deployment Status: FAILED"
          echo "ğŸ” Check the logs above for error details"
          echo ""
          echo "Common fixes:"
          echo "â€¢ Ensure GitHub Secrets are properly set"
          echo "â€¢ Check that Pages is enabled in repo settings"
          echo "â€¢ Verify workflow permissions are correct"
        fi
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          force_orphan: true